/*! bloqs 10-03-2015 */
!function(a,b){"use strict";var c={bloqs:[],code:{setup:"",loop:""}},d=25;c.bloqsToCode=function(){return c.functionCode(c.bloqs.setup,"setup"),c.functionCode(c.bloqs.loop,"loop"),c.code.setup+c.code.loop},c.functionCode=function(a,b){a===c.bloqs.loop||a===c.bloqs.setup?c.code[b]=a.code.loop:c.code[b]+="   "+a.getCode(b),a.relations.codeChildren.length>0?c.functionCode(a.getBloqById(a.relations.codeChildren),b):c.code[b]+="\n}\n"},c.createBloq=function(a,e,f){var g=a.size,h=e.rect(g[0],g[1]).move(f[0],f[1]).fill(a.color);h.connections=[{location:"",type:""}];for(var i in a.connections)h.connections.push({location:a.connections[i],type:"int"});for(var j in a.output)h.connections.push({location:"left",type:a.output[j]});for(j in a.inputs)console.log("aaaa inputs:",a.inputs[j]),h.connections.push({location:"right",type:a.inputs[j]});return console.log("aaaa",h,h.connections),h.code=a.code,h.label=a.label,h.relations={parent:b,children:[],codeChildren:[],inputChildren:[]},h.inputs=a.inputs,"setup"!==h.label&&"loop"!==h.label&&h.draggable(),h.dragmove=function(){var a=this;a.relations.parent!==b&&(a.getBloqById(a.relations.parent).deleteChild(a),a.deleteParent(!0));for(var c in a.relations.children){var d=a.getBloqById(a.relations.children[c]),e=a,f=d.location;this.connectBloqs(e,d,f)}},h.dragend=function(){for(var a in c.bloqs)for(var b in this.connections)"left"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a],!1):"right"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a],!1):"up"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a],!1):"down"===this.connections[b].location&&this!==c.bloqs[a]&&this.manageConnections(b,c.bloqs[a],!1)},h.manageConnections=function(a,b,c){var d;"up"===this.connections[a].location?d="down":"down"===this.connections[a].location?d="up":"right"===this.connections[a].location?d="left":"left"===this.connections[a].location&&(d="right");var e,f;for(var g in b.connections)if(b.connections[g].location===d&&this.connections[a].type===b.connections[g].type&&(e=this.createConnectors(this,this.connections[a].location),f=this.createConnectors(b,d),this.itsOver(e,f))){this.connectBloqs(b,this,this.connections[a].location),c===!0&&this.connectBloqs(this,this.getBloqById(this.relations.parent),this.connections[a].location);break}if(this.relations.children.length>0)for(var h in this.relations.children)for(var i in this.getBloqById(this.relations.children[h]).connections)this.getBloqById(this.relations.children[h]).manageConnections(i,b,!0)},h.connectBloqs=function(a,b,c){var d=a,e=b,f="up";if("up"===c?(b.x(a.x()),b.y(a.y()+a.height())):"down"===c?(b.x(a.x()),b.y(a.y()-a.height()),d=b,e=a):"right"===c?(b.x(a.x()-a.width()),b.y(a.y()),d=b,e=a,f="left"):"left"===c&&(b.x(a.x()+a.width()),b.y(a.y()),f="left"),e.location=f,this.updateBloqs(d,e),e.relations.children.length>0)for(var g in e.relations.children){var h=e.getBloqById(e.relations.children[g]),i=h.location;e.connectBloqs(e,h,i)}},h.updateBloqs=function(a,b){a.setChildren(b.node.id,b.location),b.setParent(a.node.id)},h.itsOver=function(a,b){return a.X1<b.X2&&a.X2>b.X1&&a.Y1<b.Y2&&a.Y2>b.Y1},h.createConnectors=function(a,b){return"left"===b?{X1:a.x(),X2:a.x()+d,Y1:a.y(),Y2:a.y()+a.height()}:"right"===b?{X1:a.x()+a.width()-d,X2:a.x()+a.width(),Y1:a.y(),Y2:a.y()+a.height()}:"down"===b?{X1:a.x()+d,X2:a.x()+a.width()-d,Y1:a.y()+a.height()-d,Y2:a.y()+a.height()}:"up"===b?{X1:a.x()+d,X2:a.x()+a.width()-d,Y1:a.y(),Y2:a.y()+d}:void 0},h.deleteParent=function(a){if(a!==!1){var c=this.getBloqById(this.relations.parent);c.relations.children=[]}this.relations.parent=b},h.deleteChild=function(a){for(var b in this.relations.children)if(this.relations.children[b]===a.node.id){this.relations.children.splice(b,1);break}for(b in this.relations.codeChildren)if(this.relations.codeChildren[b]===a.node.id){this.relations.codeChildren.splice(b,1);break}for(b in this.relations.inputChildren)if(this.relations.inputChildren[b]===a.node.id){this.relations.inputChildren.splice(b,1);break}},h.setChildren=function(a,b){for(var c in this.relations.children)if(a==this.relations.children[c])return!1;return this.relations.children.push(a),"up"===b?this.relations.codeChildren.push(a):this.relations.inputChildren.push(a),!0},h.setParent=function(a){return this.relations.parent=a,!0},h.getBloqById=function(a){for(var b in c.bloqs){var d=c.bloqs[b];if(d.node.id==a)return d}return null},h.getCode=function(a){var b=this.code[a],c="",d="";for(var e in this.relations.inputChildren)d=this.getBloqById(this.relations.inputChildren).getCode(a),c="{["+e+"]}",b=b.replace(new RegExp(c,"g"),d);console.log("aaaaaaaaaa",this,this.inputs);for(e in this.inputs)c="{["+e+"]}",b=b.replace(new RegExp(c,"g")," ");return b},"loop"===h.label?c.bloqs.loop=h:"setup"===h.label&&(c.bloqs.setup=h),c.bloqs.push(h),h};var e=function(){return c};a.bloqs=e}(this);