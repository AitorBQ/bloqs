/*! bloqs 10-03-2015 */
!function(a,b){"use strict";var c={bloqs:[]},d=50;c.bloqsToCode=function(){var a="void setup (){\n",b="void loop (){\n";for(var d in c.bloqs)a+="  "+c.bloqs[d].code.setup,b+="  "+c.bloqs[d].code.loop,a+="\n",b+="\n";return a+="}\n",b+="}\n",a+b},c.createBloq=function(a,e,f){var g=a.size,h=e.rect(g[0],g[1]).move(f[0],f[1]).fill(a.color);return h.connections=a.connections,h.code=a.code,h.relations={parent:b,children:[]},h.location="",h.draggable(),h.dragmove=function(){var a=this;a.relations.parent!==b&&a.deleteParent(!0);for(var c in a.relations.children){var d=a.getBloqById(a.relations.children[c]),e=a,f=d.location;this.connectBloqs(e,d,f)}},h.dragend=function(){for(var a in c.bloqs)for(var b in this.connections)"left"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a]):"right"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a]):"up"===this.connections[b].location&&this!==c.bloqs[a]?this.manageConnections(b,c.bloqs[a]):"down"===this.connections[b].location&&this!==c.bloqs[a]&&this.manageConnections(b,c.bloqs[a])},h.manageConnections=function(a,b,c){var d;"up"===this.connections[a].location?d="down":"down"===this.connections[a].location?d="up":"right"===this.connections[a].location?d="left":"left"===this.connections[a].location&&(d="right");var e,f;for(var g in b.connections)if(b.connections[g].location===d&&this.connections[a].type===b.connections[g].type&&(e=this.createConnectors(this,this.connections[a].location),f=this.createConnectors(b,d),this.itsOver(e,f))){this.connectBloqs(b,this,this.connections[a].location),c===!0&&this.connectBloqs(this,this.getBloqById(this.relations.parent),this.connections[a].location);break}if(this.relations.children.length>0)for(var h in this.relations.children)console.log("aaa",this.getBloqById(this.relations.children[h])),this.getBloqById(this.relations.children[h]).manageConnections(a,b,!0)},h.connectBloqs=function(a,b,c){var d=a,e=b,f="up";if("up"===c?(b.x(a.x()),b.y(a.y()+a.height())):"down"===c?(b.x(a.x()),b.y(a.y()-a.height()),d=b,e=a):"right"===c?(b.x(a.x()-a.width()),b.y(a.y()),d=b,e=a,f="left"):"left"===c&&(b.x(a.x()+a.width()),b.y(a.y()),f="left"),e.location=f,this.updateBloqs(d,e),e.relations.children.length>0)for(var g in e.relations.children){var h=e.getBloqById(e.relations.children[g]),i=h.location;e.connectBloqs(e,h,i)}},h.updateBloqs=function(a,b){a.setChildren(b.node.id),b.setParent(a.node.id)},h.itsOver=function(a,b){return a.X1<b.X2&&a.X2>b.X1&&a.Y1<b.Y2&&a.Y2>b.Y1},h.createConnectors=function(a,b){return"left"===b?{X1:a.x(),X2:a.x()+d,Y1:a.y(),Y2:a.y()+a.height()}:"right"===b?{X1:a.x()+a.width()-d,X2:a.x()+a.width(),Y1:a.y(),Y2:a.y()+a.height()}:"down"===b?{X1:a.x()+d,X2:a.x()+a.width()-d,Y1:a.y()+a.height()-d,Y2:a.y()+a.height()}:"up"===b?{X1:a.x()+d,X2:a.x()+a.width()-d,Y1:a.y(),Y2:a.y()+d}:void 0},h.deleteParent=function(a){if(a!==!1){var c=this.getBloqById(this.relations.parent);c.relations.children=[]}this.relations.parent=b},h.setChildren=function(a){for(var b in this.relations.children)if(a==this.relations.children[b])return!1;return this.relations.children.push(a),!0},h.setParent=function(a){return this.relations.parent=a,!0},h.getBloqById=function(a){for(var b in c.bloqs){var d=c.bloqs[b];if(d.node.id==a)return d}return null},c.bloqs.push(h),h};var e=function(){return c};a.bloqs=e}(this);